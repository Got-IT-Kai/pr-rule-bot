name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]
    # Removed 'reopened' to prevent close/reopen spam attacks

permissions:
  contents: read
  pull-requests: write
  id-token: write  # Required for Workload Identity Federation

jobs:
  ai-review:
    name: AI Code Review with Gemini
    runs-on: ubuntu-latest
    # Only run for PRs from repository collaborators or owner
    if: |
      github.event.pull_request.head.repo.full_name == github.repository ||
      contains(fromJSON('["OWNER", "MEMBER", "COLLABORATOR"]'), github.event.pull_request.author_association)

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'
          cache: gradle

      # Ollama setup (commented out - use for local development with docker-compose)
      # - name: Start Ollama with pre-built image
      #   run: |
      #     # Pull pre-built image with model included from GHCR
      #     docker pull ghcr.io/got-it-kai/pr-rule-bot-ollama:3b
      #
      #     # Run Ollama container
      #     docker run -d --name ollama-ci -p 11434:11434 ghcr.io/got-it-kai/pr-rule-bot-ollama:3b
      #
      #     # Wait for Ollama service to start
      #     echo "Waiting for Ollama service to start..."
      #     timeout 30 sh -c 'until curl -s http://localhost:11434/api/tags > /dev/null; do sleep 2; done'
      #     echo "Ollama service is ready!"
      #
      #     # Verify model is available
      #     echo "Checking if model is available..."
      #     MODELS=$(curl -s http://localhost:11434/api/tags | jq -r '.models[].name')
      #     echo "Available models: $MODELS"
      #
      #     if ! echo "$MODELS" | grep -q "qwen2.5-coder:3b"; then
      #       echo "ERROR: qwen2.5-coder:3b model not found!"
      #       docker logs ollama-ci
      #       exit 1
      #     fi
      #
      #     echo "Model qwen2.5-coder:3b is ready!"
      #     docker logs ollama-ci

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew

      - name: Run AI Code Review with Gemini
        timeout-minutes: 20
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
          AI_PROVIDER: gemini
          GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
          GCP_LOCATION: us-central1
          SPRING_PROFILES_ACTIVE: cli,ci
          FORCE_REVIEW: false
        run: |
          ./gradlew bootRun --args="cli" --no-daemon

      # Ollama cleanup (commented out)
      # - name: Show Ollama logs after review
      #   if: always()
      #   run: |
      #     echo "=== Ollama container logs ==="
      #     docker logs ollama-ci --tail 100
      #
      # - name: Stop Ollama
      #   if: always()
      #   run: docker stop ollama-ci && docker rm ollama-ci
